<script lang="ts">
    import { onMount } from "svelte";
    import type { ActivityProps } from "$lib/interfaces";

    import { activites } from "./activities";
    import { tick } from "svelte";

    import Time from "./Time.svelte";
    import Activity from "./Activity.svelte";
    import { i18n } from "$lib/i18n";

    /** Unbiased shuffle algorithm
     * Credit: https://stackoverflow.com/a/2450976
     */
    function fisherYatesShuffle(array: ActivityProps[]) {
        let currentIndex = array.length;
        let randomIndex;

        // While there remain elements to shuffle
        while (currentIndex != 0) {
            // Pick a remaining element
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;

            // And swap it with the current element
            [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
        }

        return array;
    }

    let randomizedActivites: ActivityProps[] = [];

    onMount(() => {
        randomizedActivites = fisherYatesShuffle(activites);
    });

    let currentActivityIndex: number = -1;
    let show: boolean = true;

    // TODO: Add background animation
    // TODO: Add a timer that counts down the time left for the current activity
</script>

{#if randomizedActivites.length > 0}
    <button
        class="bg-[#7C45C1] w-screen h-screen flex flex-col justify-center items-center content-center text-white gap-20"
        on:click={async () => {
            currentActivityIndex = (currentActivityIndex + 1) % randomizedActivites.length;
            show = false;
            await tick();
            show = true;
        }}
    >
        {#if show}
            <div
                class="dots w-screen h-screen flex flex-col justify-center gap-14 align-center items-center"
            >
                <p class="text-4xl font-black fixed top-14 tracking-wider">Activities</p>

                {#if currentActivityIndex === -1}
                    <p class="text-3xl font-bold animate-pulse">
                        {$i18n.t("tapToStart")}
                    </p>
                {:else}
                    <Time duration={randomizedActivites[currentActivityIndex].duration} />

                    <Activity i18nKey={randomizedActivites[currentActivityIndex].key} />
                {/if}
            </div>
        {/if}
    </button>
{/if}

<style>
    .dots {
        background: radial-gradient(rgba(255, 255, 255, 0.1) 8%, transparent 8%);

        background-position: 0% 0%;
        background-size: 5vmin 5vmin;
    }
</style>
